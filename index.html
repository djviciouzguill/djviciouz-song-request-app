<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DJ Viciouz — Song Request</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{--bg1:#000;--bg2:#111;--fg:#fff;--muted:#b3b3b3;--line:#222;--panel:#0a0a0a;--btn:#1e1e1e;--btnb:#333;--accent:#00d0ff}
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(circle at center,var(--bg2),var(--bg1));color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:22px}
    header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    header img{height:56px;width:auto;border-radius:8px}
    h1{font-size:22px;margin:0}
    .status{font-size:13px;opacity:.85;margin-top:4px}
    .bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .pill{padding:8px 10px;border-radius:999px;background:#101010;border:1px solid #2a2a2a}
    .search{flex:1;min-width:240px}
    .search input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #333;background:#0c0c0c;color:#fff}
    .btn{background:var(--btn);border:1px solid var(--btnb);color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:hover{border-color:#555}
    .loading{display:inline-flex;gap:8px;align-items:center;border:1px solid #2a2a2a;background:var(--panel);padding:10px 12px;border-radius:10px;margin-top:10px}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 12px var(--accent);animation:pulse 1s infinite alternate}
    @keyframes pulse{from{transform:scale(.8);opacity:.6}to{transform:scale(1.2);opacity:1}}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left}
    th{position:sticky;top:0;background:var(--panel);border-bottom:1px solid #333;z-index:1}
    td.muted{color:var(--muted)}
    tbody tr:hover{background:#0d0d0d}
    .btn-sm{padding:6px 10px;border-radius:8px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="djviciouzbranding.png" alt="DJ Viciouz" />
      <div>
        <h1>DJ Viciouz — Song Request Library</h1>
        <div class="status" id="status">Loading library…</div>
      </div>
    </header>

    <div class="bar">
      <div class="search"><input id="search" type="text" placeholder="Search artist, title, or genre…" disabled></div>
      <button class="btn" id="btnFirst">Show first 10</button>
      <button class="btn" id="btnRandom">Random 25</button>
      <button class="btn" id="btnMore">Show more</button>
      <span class="pill" id="count">0 / 0 shown</span>
    </div>

    <div class="loading" id="loader"><span class="dot"></span> <span>Fetching CSV…</span></div>

    <table>
      <thead>
        <tr>
          <th style="width:26%">Artist</th>
          <th style="width:36%">Title</th>
          <th style="width:8%">BPM</th>
          <th style="width:14%">genre</th>
          <th style="width:8%">Year</th>
          <th style="width:8%">Request</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script>
    // ===== CSV SOURCE (same-origin on GitHub Pages) =====
    const CSV_URL = 'djviciouz_serato_library_v2.csv';
    // Or use raw.githubusercontent if you prefer:
    // const CSV_URL = 'https://raw.githubusercontent.com/djviciouzguill/djviciouz-song-request-app/main/djviciouz_serato_library_v2.csv';

    // ===== EXPECTED HEADERS =====
    // artist,title,bpm,genre,year

    // Performance knobs
    const PAGE = 10;          // quick first paint
    const MAX_RENDER = 200;   // cap DOM rows for smoothness
    const MORE_STEP = 100;    // rows appended per "Show more"

    const allRows = [];
    let viewRows = [];
    let shown = 0;

    const $ = s => document.querySelector(s);
    const tbody = $('#tbody');

    // ===== Request settings (replace with your number) =====
    const REQUEST_SMS_NUMBER = '15551234567'; // digits only
    const REQUEST_SMS = `sms:+${REQUEST_SMS_NUMBER}`;

    function esc(s){return String(s ?? '').replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}
    function clean(v){return (v ?? '').toString().trim()}

    function requestSong(row){
      const body = encodeURIComponent(`Song request: ${row.artist} - ${row.title}`);
      const url = `${REQUEST_SMS}&body=${body}`;
      window.open(url, '_blank');
    }

    function render(slice, append=false){
      const frag = document.createDocumentFragment();
      const limited = slice.slice(0, MAX_RENDER - (append ? tbody.rows.length : 0));
      for (const r of limited){
        const tr = document.createElement('tr');
        tr.innerHTML =
          `<td>${esc(r.artist)}</td>
           <td>${esc(r.title)}</td>
           <td class="muted">${esc(r.bpm)}</td>
           <td class="muted">${esc(r.genre)}</td>
           <td class="muted">${esc(r.year)}</td>
           <td><button class="btn btn-sm" onclick='requestSong(${JSON.stringify(r)})'>Request</button></td>`;
        frag.appendChild(tr);
      }
      if(!append) tbody.innerHTML = '';
      tbody.appendChild(frag);
      $('#count').textContent = `${tbody.rows.length} / ${(viewRows.length || allRows.length)} shown`;
      $('#btnMore').disabled = shown >= viewRows.length || tbody.rows.length >= MAX_RENDER;
    }

    function showFirst(){
      viewRows = allRows.slice();
      shown = 0;
      const slice = viewRows.slice(0, PAGE);
      shown += slice.length;
      render(slice, false);
    }

    function showRandom(){
      const n = Math.min(25, allRows.length);
      const idxs = Array.from({length: allRows.length}, (_, i) => i);
      for(let i=idxs.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[idxs[i],idxs[j]]=[idxs[j],idxs[i]];}
      viewRows = idxs.slice(0,n).map(i => allRows[i]);
      shown = n;
      render(viewRows, false);
    }

    function showMore(){
      if(!viewRows.length) return;
      const slice = viewRows.slice(shown, shown+MORE_STEP);
      shown += slice.length;
      if(slice.length) render(slice, true);
    }

    function applySearch(q){
      q = (q || '').toLowerCase();
      viewRows = !q ? allRows.slice() :
        allRows.filter(r => (r.artist + ' ' + r.title + ' ' + r.genre).toLowerCase().includes(q));
      shown = 0;
      const slice = viewRows.slice(0, PAGE);
      shown += slice.length;
      render(slice, false);
    }

    function enableUI(total){
      $('#loader').style.display = 'none';
      $('#status').textContent = `${total} tracks loaded`;
      $('#search').disabled = false;
      showFirst();
    }

    // ===== Load & parse CSV off the main thread =====
    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      worker: true,          // parse in a Web Worker
      chunkSize: 1024 * 64,  // ~64KB chunks
      chunk: (results) => {
        for (const r of results.data) {
          const row = {
            artist: clean(r.artist),
            title:  clean(r.title),
            bpm:    clean(r.bpm),
            genre:  clean(r.genre),
            year:   clean(r.year)
          };
          if (row.artist || row.title) allRows.push(row);
        }
        // First paint as soon as we have enough
        if (allRows.length >= PAGE && $('#search').disabled) {
          enableUI(allRows.length);
        }
      },
      complete: () => {
        if (!allRows.length) {
          $('#loader').style.display = 'none';
          $('#status').textContent = 'No rows found. Check headers: artist,title,bpm,genre,year';
          return;
        }
        if ($('#search').disabled) enableUI(allRows.length);
      },
      error: (err) => {
        $('#loader').style.display = 'none';
        $('#status').textContent = 'Failed to load CSV (check path/filename).';
        console.error(err);
      }
    });

    // ===== Events =====
    $('#btnFirst').addEventListener('click', showFirst);
    $('#btnRandom').addEventListener('click', showRandom);
    $('#btnMore').addEventListener('click', showMore);

    let t=null;
    $('#search').addEventListener('input', (e)=>{
      clearTimeout(t);
      const q = e.target.value;
      t = setTimeout(()=> applySearch(q), 120);
    });
  </script>
</body>
</html>
